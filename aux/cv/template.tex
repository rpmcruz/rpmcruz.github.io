\documentclass[11pt]{article}

\usepackage[a4paper, margin=2cm]{geometry}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage[hidelinks]{hyperref}
\usepackage{xcolor}
\definecolor{dark-blue}{rgb}{0.15,0.15,0.4}
\hypersetup{colorlinks, linkcolor={dark-blue}, citecolor={dark-blue}, urlcolor={dark-blue}}
\usepackage[scaled=0.85]{beramono}
\setlength{\parindent}{0cm}

\usepackage{lastpage}
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\cfoot{Page \thepage\ of \pageref{LastPage}}

\usepackage{changepage}
\usepackage{tikz}
\usetikzlibrary{tikzmark, calc}

\newcommand{\caixaaberta}[1]{\tikzmark{#1}%
\begin{tikzpicture}[thick, black!70, xshift=-1.5em, overlay, baseline=0.5pt]
\draw (0,0) rectangle (0.3,0.3);
\draw (0.1,0.15) -- (0.2,0.15);
\end{tikzpicture}}

\newcommand{\caixafechada}[1]{\tikzmark{#1}%
\begin{tikzpicture}[thick, black!70, xshift=-1.5em, overlay, baseline=0.5pt]
\draw (0,0) rectangle (0.3,0.3);
\draw (0.1,0.15) -- (0.2,0.15);
\draw (0.15,0.1) -- (0.15,0.2);
\end{tikzpicture}}

\begin{document}

% photo and personal information
\fcolorbox{black!25}{black!5}{\begin{minipage}{\linewidth}
\tt
\textbf{\large Ricardo Cruz}\\
\raisebox{-0.25\height}{\includegraphics[width=1em]{imgs/email}} \href{mailto:ricardo.pdm.cruz@gmail.com}{ricardo.pdm.cruz@gmail.com}\\
\raisebox{-0.25\height}{\includegraphics[width=1em]{imgs/www}} \href{https://rpmcruz.github.io/}{https://rpmcruz.github.io/}\\
+351 934741617 $\bullet$ Valongo, Portugal
\end{minipage}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

@% macro massajar(text) -%@
@@ myurlize(text
    .replace('<i>', '\\textit{').replace('</i>', '}')
    .replace('<b>', '\\textbf{').replace('</b>', '}')
    .replace('<ol>', '\\begin{itemize}').replace('</ol>', '\end{itemize}')
    .replace('<li>', '\\item ').replace('</li>', '')
    .replace('&', '\\& ')
    .replace(' "', ' ``').replace('" ', "'' ")
    .replace('\n', '\n\n'), '\\\\url{', '}') @@
@%- endmacro %@

@% macro escrever(item_id, item, depth) -%@
@% if depth < 2 %@
\smallskip
@% if item.tree %@\caixaaberta{@@ item_id @@}@% else %@\caixafechada{@@ item_id @@}@% endif %@
@% if item.date %@@@ item.date @@, @% endif %@\textbf{@@ item.title @@}@% if item.subtitle %@\\@%if item.image %@\begin{minipage}[t]{0.88\linewidth}@% endif %@@@ massajar(item.subtitle) @@@%if item.image %@\end{minipage}\hfill\begin{minipage}[t]{0.1\linewidth}\strut\vspace*{-\baselineskip}\newline\includegraphics[width=\linewidth]{imgs/@@ item.image @@}\end{minipage}@% endif %@@% endif %@

@% if item.description %@\begin{adjustwidth}{1.5em}{}\footnotesize @@ massajar(item.description) @@\end{adjustwidth}@% endif %@
@% else %@
\begin{minipage}[t]{@%if item.image %@0.88@% endif %@\linewidth}
@% if item.tree %@\caixaaberta{@@ item_id @@}@% else %@\caixafechada{@@ item_id @@}@% endif %@\color{black!70}\footnotesize@% if item.date %@ @@ item.date @@, @% endif %@\textbf{@@ item.title @@@% if item.description %@:@% endif %@}@% if item.description %@ @@ massajar(item.description) @@@% endif %@
\vspace{2pt}\end{minipage}@%if item.image %@\hfill\begin{minipage}[t]{0.1\linewidth}\strut\vspace*{-\baselineskip}\newline\includegraphics[width=\linewidth]{imgs/@@ item.image @@}\end{minipage}@% endif %@
@% endif %@

@% if item.tree %@%
\begin{adjustwidth}{1.5em}{}%
@% for subitem in item.tree %@@% set subitem_id = item_id + loop.index|string %@%
@@ escrever(subitem_id, subitem, depth+1) @@%
@% endfor %@%
\end{adjustwidth}%
@% endif %@
@%- endmacro %@

@% macro desenhar(item_id, item, depth) -%@
@% if item.tree %@%
@% for subitem in item.tree %@@% set subitem_id = item_id + loop.index|string %@%
@@ desenhar(subitem_id, subitem, depth+1) @@%
\draw[dashed, black!60] let \p1=(pic cs:@@ subitem_id @@) in ({\x1-9mm,\y1+1mm}) -- (\x1-6mm,\y1+1mm);
@% endfor %@%
\draw[dashed, black!60] let \p1=(pic cs:@@ item_id @@), \p2=(pic cs:@@ item_id @@@@ item.tree|length @@) in ({\x1-4mm,\y1-1mm}) -- ({\x1-4mm,\y2+1mm});
@% endif %@%
@%- endmacro %@


\medskip
\begin{adjustwidth}{1.5em}{}%
@% for item in cv %@
\filbreak
@@ escrever('cv' + loop.index|string, item, 0) @@
\begin{tikzpicture}[overlay, remember picture]
@@ desenhar('cv' + loop.index|string, item, 0) @@
\end{tikzpicture}%
@% endfor %@
\end{adjustwidth}%

\end{document}

